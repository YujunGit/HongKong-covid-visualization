<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦™æ¸¯ç–«æƒ…æ•°æ®å¯è§†åŒ–å¤§å±</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto auto;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card h3 {
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .chart-container {
            width: 100%;
            height: 400px;
        }

        .summary-cards {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .summary-card h4 {
            font-size: 1.1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-card .rate {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #ff6b6b;
            font-size: 1.2em;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¥ é¦™æ¸¯ç–«æƒ…æ•°æ®å¯è§†åŒ–å¤§å±</h1>
        <p>å®æ—¶ç›‘æ§ç–«æƒ…åŠ¨æ€ï¼Œç§‘å­¦é˜²æ§å…±å…‹æ—¶è‰°</p>
    </div>

    <div class="dashboard">
        <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
        <div class="summary-cards">
            <div class="summary-card">
                <h4>ç´¯è®¡ç¡®è¯Š</h4>
                <div class="value" id="total-cases">-</div>
                <div class="rate">æ€»ç¡®è¯Šç—…ä¾‹æ•°</div>
            </div>
            <div class="summary-card">
                <h4>ç´¯è®¡åº·å¤</h4>
                <div class="value" id="total-recovered">-</div>
                <div class="rate" id="recovery-rate">-</div>
            </div>
            <div class="summary-card">
                <h4>ç´¯è®¡æ­»äº¡</h4>
                <div class="value" id="total-deaths">-</div>
                <div class="rate" id="death-rate">-</div>
            </div>
            <div class="summary-card">
                <h4>ç°å­˜ç¡®è¯Š</h4>
                <div class="value" id="active-cases">-</div>
                <div class="rate">å½“å‰æ´»è·ƒç—…ä¾‹</div>
            </div>
            <div class="summary-card">
                <h4>æœ€é«˜å•æ—¥æ–°å¢</h4>
                <div class="value" id="max-daily">-</div>
                <div class="rate" id="max-date">-</div>
            </div>
        </div>

        <!-- å›¾è¡¨1: æ¯æ—¥æ–°å¢ç¡®è¯Šè¶‹åŠ¿ -->
        <div class="card">
            <h3>ğŸ“ˆ æ¯æ—¥æ–°å¢ç¡®è¯Šè¶‹åŠ¿</h3>
            <div class="chart-container" id="daily-trend-chart"></div>
        </div>

        <!-- å›¾è¡¨2: å„åœ°åŒºç´¯è®¡ç¡®è¯Šå¯¹æ¯” -->
        <div class="card">
            <h3>ğŸ“Š å„åœ°åŒºç´¯è®¡ç¡®è¯Šå¯¹æ¯”</h3>
            <div class="chart-container" id="region-bar-chart"></div>
        </div>

        <!-- å›¾è¡¨3: ç´¯è®¡ç¡®è¯Šå¢é•¿è¶‹åŠ¿ -->
        <div class="card">
            <h3>ğŸ“‰ ç´¯è®¡ç¡®è¯Šå¢é•¿è¶‹åŠ¿</h3>
            <div class="chart-container" id="cumulative-area-chart"></div>
        </div>

        <!-- å›¾è¡¨4: å„åœ°åŒºå‘ç—…ç‡çƒ­åŠ›å›¾ -->
        <div class="card">
            <h3>ğŸ—ºï¸ å„åœ°åŒºå‘ç—…ç‡çƒ­åŠ›å›¾</h3>
            <div class="chart-container" id="incidence-heatmap-chart"></div>
        </div>


        <!-- å›¾è¡¨6: é¦™æ¸¯åœ°åŒºç´¯è®¡ç¡®è¯Šåˆ†å¸ƒåœ°å›¾ -->
        <div class="card" style="grid-column: 1 / -1;">
            <h3>ğŸ—ºï¸ é¦™æ¸¯åœ°åŒºç´¯è®¡ç¡®è¯Šåˆ†å¸ƒåœ°å›¾</h3>
            <div class="chart-container" id="hk-map-chart" style="height: 500px;"></div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
        function initCharts() {
            loadSummaryData();
            initDailyTrendChart();
            initRegionBarChart();
            initCumulativeAreaChart();
            initIncidenceHeatmapChart();
            initHKMapChart();
        }

        // åŠ è½½æ±‡æ€»æ•°æ®
        async function loadSummaryData() {
            try {
                const response = await fetch('/api/summary_data');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // æ›´æ–°å…³é”®æŒ‡æ ‡å¡ç‰‡
                document.getElementById('total-cases').textContent = data.total_cases.toLocaleString();
                document.getElementById('total-recovered').textContent = data.total_recovered.toLocaleString();
                document.getElementById('total-deaths').textContent = data.total_deaths.toLocaleString();
                document.getElementById('active-cases').textContent = data.active_cases.toLocaleString();
                document.getElementById('max-daily').textContent = data.max_daily_new.toLocaleString();
                document.getElementById('recovery-rate').textContent = `åº·å¤ç‡: ${data.recovery_rate}%`;
                document.getElementById('death-rate').textContent = `æ­»äº¡ç‡: ${data.death_rate}%`;
                document.getElementById('max-date').textContent = data.max_daily_date;
            } catch (error) {
                console.error('åŠ è½½æ±‡æ€»æ•°æ®å¤±è´¥:', error);
            }
        }

        // å›¾è¡¨1: æ¯æ—¥æ–°å¢ç¡®è¯Šè¶‹åŠ¿
        async function initDailyTrendChart() {
            try {
                const response = await fetch('/api/daily_data');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                const chart = echarts.init(document.getElementById('daily-trend-chart'));
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: '#fff',
                        textStyle: { color: '#fff' }
                    },
                    legend: {
                        data: ['æ–°å¢ç¡®è¯Š', 'æ–°å¢åº·å¤', 'æ–°å¢æ­»äº¡'],
                        textStyle: { color: '#fff' }
                    },
                    xAxis: {
                        type: 'category',
                        data: data.dates,
                        axisLabel: { color: '#fff' }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: { color: '#fff' }
                    },
                    series: [
                        {
                            name: 'æ–°å¢ç¡®è¯Š',
                            type: 'line',
                            data: data.new_cases,
                            smooth: true,
                            lineStyle: { color: '#ff6b6b', width: 3 },
                            itemStyle: { color: '#ff6b6b' },
                            areaStyle: { 
                                color: {
                                    type: 'linear',
                                    x: 0, y: 0, x2: 0, y2: 1,
                                    colorStops: [
                                        { offset: 0, color: 'rgba(255, 107, 107, 0.3)' },
                                        { offset: 1, color: 'rgba(255, 107, 107, 0.1)' }
                                    ]
                                }
                            }
                        },
                        {
                            name: 'æ–°å¢åº·å¤',
                            type: 'line',
                            data: data.new_recovered,
                            smooth: true,
                            lineStyle: { color: '#51cf66', width: 2 },
                            itemStyle: { color: '#51cf66' }
                        },
                        {
                            name: 'æ–°å¢æ­»äº¡',
                            type: 'line',
                            data: data.new_deaths,
                            smooth: true,
                            lineStyle: { color: '#ffd43b', width: 2 },
                            itemStyle: { color: '#ffd43b' }
                        }
                    ]
                };
                chart.setOption(option);
            } catch (error) {
                console.error('åˆå§‹åŒ–æ¯æ—¥è¶‹åŠ¿å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // å›¾è¡¨2: å„åœ°åŒºç´¯è®¡ç¡®è¯Šå¯¹æ¯”
        async function initRegionBarChart() {
            try {
                const response = await fetch('/api/region_data');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                const chart = echarts.init(document.getElementById('region-bar-chart'));
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: '#fff',
                        textStyle: { color: '#fff' }
                    },
                    xAxis: {
                        type: 'category',
                        data: data.regions,
                        axisLabel: { 
                            color: '#fff',
                            rotate: 45,
                            fontSize: 10
                        }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: { color: '#fff' }
                    },
                    series: [{
                        name: 'ç´¯è®¡ç¡®è¯Š',
                        type: 'bar',
                        data: data.cumulative_cases,
                        itemStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: '#ff6b6b' },
                                    { offset: 1, color: '#ff8e8e' }
                                ]
                            }
                        }
                    }]
                };
                chart.setOption(option);
            } catch (error) {
                console.error('åˆå§‹åŒ–åœ°åŒºå¯¹æ¯”å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // å›¾è¡¨3: ç´¯è®¡ç¡®è¯Šå¢é•¿è¶‹åŠ¿
        async function initCumulativeAreaChart() {
            try {
                const response = await fetch('/api/daily_data');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                const chart = echarts.init(document.getElementById('cumulative-area-chart'));
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: '#fff',
                        textStyle: { color: '#fff' }
                    },
                    legend: {
                        data: ['ç´¯è®¡ç¡®è¯Š', 'ç´¯è®¡åº·å¤', 'ç´¯è®¡æ­»äº¡'],
                        textStyle: { color: '#fff' }
                    },
                    xAxis: {
                        type: 'category',
                        data: data.dates,
                        axisLabel: { color: '#fff' }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: { color: '#fff' }
                    },
                    series: [
                        {
                            name: 'ç´¯è®¡ç¡®è¯Š',
                            type: 'line',
                            data: data.cumulative_cases,
                            smooth: true,
                            lineStyle: { color: '#ff6b6b', width: 3 },
                            itemStyle: { color: '#ff6b6b' },
                            areaStyle: { 
                                color: {
                                    type: 'linear',
                                    x: 0, y: 0, x2: 0, y2: 1,
                                    colorStops: [
                                        { offset: 0, color: 'rgba(255, 107, 107, 0.4)' },
                                        { offset: 1, color: 'rgba(255, 107, 107, 0.1)' }
                                    ]
                                }
                            }
                        },
                        {
                            name: 'ç´¯è®¡åº·å¤',
                            type: 'line',
                            data: data.cumulative_recovered,
                            smooth: true,
                            lineStyle: { color: '#51cf66', width: 2 },
                            itemStyle: { color: '#51cf66' }
                        },
                        {
                            name: 'ç´¯è®¡æ­»äº¡',
                            type: 'line',
                            data: data.cumulative_deaths,
                            smooth: true,
                            lineStyle: { color: '#ffd43b', width: 2 },
                            itemStyle: { color: '#ffd43b' }
                        }
                    ]
                };
                chart.setOption(option);
            } catch (error) {
                console.error('åˆå§‹åŒ–ç´¯è®¡è¶‹åŠ¿å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // å›¾è¡¨4: å„åœ°åŒºå‘ç—…ç‡çƒ­åŠ›å›¾
        async function initIncidenceHeatmapChart() {
            try {
                const response = await fetch('/api/region_data');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                const chart = echarts.init(document.getElementById('incidence-heatmap-chart'));
                const option = {
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: '#fff',
                        textStyle: { color: '#fff' },
                        formatter: function(params) {
                            return `${params.name}<br/>å‘ç—…ç‡: ${params.value}/10ä¸‡`;
                        }
                    },
                    series: [{
                        name: 'å‘ç—…ç‡',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        data: data.regions.map((region, index) => ({
                            name: region,
                            value: data.incidence_rates[index]
                        })),
                        itemStyle: {
                            borderRadius: 8,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: true,
                            color: '#fff',
                            fontSize: 10
                        },
                        labelLine: {
                            show: true,
                            lineStyle: { color: '#fff' }
                        }
                    }]
                };
                chart.setOption(option);
            } catch (error) {
                console.error('åˆå§‹åŒ–å‘ç—…ç‡çƒ­åŠ›å›¾å¤±è´¥:', error);
            }
        }


        // å›¾è¡¨6: é¦™æ¸¯åœ°åŒºç´¯è®¡ç¡®è¯Šåˆ†å¸ƒåœ°å›¾
        async function initHKMapChart() {
            try {
                // åŠ è½½åœ°å›¾æ•°æ®
                const mapResponse = await fetch('/static/geojson/hongkong.json');
                const hkGeoJson = await mapResponse.json();
                
                // æ³¨å†Œåœ°å›¾
                echarts.registerMap('hongkong', hkGeoJson);
                
                // è·å–ç–«æƒ…æ•°æ®
                const dataResponse = await fetch('/api/map_data');
                const data = await dataResponse.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                const chart = echarts.init(document.getElementById('hk-map-chart'));
                const option = {
                    title: {
                        text: 'é¦™æ¸¯å„åŒºç´¯è®¡ç¡®è¯Šåˆ†å¸ƒ',
                        left: 'center',
                        textStyle: {
                            color: '#fff',
                            fontSize: 18
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderColor: '#fff',
                        textStyle: { color: '#fff' },
                        formatter: function(params) {
                            if (params.data) {
                                const displayName = params.data.chinese_name ? 
                                    `${params.data.chinese_name}ï¼ˆ${params.name}ï¼‰` : 
                                    params.name;
                                return `${displayName}<br/>
                                        ç´¯è®¡ç¡®è¯Š: ${params.data.value.toLocaleString()} ä¾‹<br/>
                                        å‘ç—…ç‡: ${params.data.incidence_rate}/10ä¸‡<br/>
                                        ç°å­˜ç¡®è¯Š: ${params.data.active_cases.toLocaleString()} ä¾‹<br/>
                                        äººå£: ${params.data.population.toLocaleString()} äºº`;
                            }
                            return `${params.name}<br/>æš‚æ— æ•°æ®`;
                        }
                    },
                    visualMap: {
                        min: data.min_cases,
                        max: data.max_cases,
                        left: 'left',
                        top: 'bottom',
                        text: ['é«˜', 'ä½'],
                        textStyle: { color: '#fff' },
                        calculable: true,
                        inRange: {
                            color: ['#50a3ba', '#eac736', '#d94e5d']
                        }
                    },
                    series: [
                        {
                            name: 'ç´¯è®¡ç¡®è¯Š',
                            type: 'map',
                            map: 'hongkong',
                            roam: true,
                            scaleLimit: {
                                min: 0.8,
                                max: 3
                            },
                            label: {
                                show: true,
                                color: '#fff',
                                fontSize: 10,
                                formatter: function(params) {
                                    // æ˜¾ç¤ºä¸­æ–‡åç§°
                                    return params.data ? params.data.chinese_name : params.name;
                                }
                            },
                            itemStyle: {
                                borderColor: '#fff',
                                borderWidth: 1
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    color: '#fff',
                                    fontSize: 12
                                },
                                itemStyle: {
                                    areaColor: '#ff6b6b',
                                    borderColor: '#fff',
                                    borderWidth: 2
                                }
                            },
                            data: data.map_data
                        }
                    ]
                };
                chart.setOption(option);
            } catch (error) {
                console.error('åˆå§‹åŒ–é¦™æ¸¯åœ°å›¾å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å›¾è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            
            // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®
            setInterval(function() {
                loadSummaryData();
            }, 30000);
        });

        // å“åº”å¼å¤„ç†
        window.addEventListener('resize', function() {
            const charts = [
                'daily-trend-chart',
                'region-bar-chart', 
                'cumulative-area-chart',
                'incidence-heatmap-chart',
                'hk-map-chart'
            ];
            
            charts.forEach(chartId => {
                const chart = echarts.getInstanceByDom(document.getElementById(chartId));
                if (chart) {
                    chart.resize();
                }
            });
        });
    </script>
</body>
</html>
